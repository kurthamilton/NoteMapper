@page "/account/register"
@layout ContentLayout
@attribute [AllowAnonymous]
@using NoteMapper.Core
@using NoteMapper.Core.Users;
@using NoteMapper.Services.Users
@using NoteMapper.Web.Blazor.Models
@using NoteMapper.Web.Blazor.Models.Account
@using NoteMapper.Web.Blazor.Shared.Layouts
@using NoteMapper.Web.Blazor.Shared.Shared

<h1>Register</h1>

@if (Feedback == null)
{
    <EditForm Model="@Model" OnValidSubmit="@HandleValidSubmitAsync">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <InputText id="email" @bind-Value="Model.Email" class="form-control" />
            <ValidationMessage For="() => Model.Email" />
        </div>

        <div>
            <button type="submit" class="btn btn-primary">Send link</button>            
        </div>
    </EditForm>
}
else
{
    <Feedback Model="@Feedback" />
}

@inject IIdentityService IdentityService
@code {
    FeedbackViewModel? Feedback { get; set; }

    RegisterViewModel Model { get; set; } = new();

    RegistrationType RegistrationType { get; set; }

    protected override void OnInitialized()
    {
        RegistrationType = IdentityService.GetRegistrationType();
        if (RegistrationType == RegistrationType.Closed)
        {
            Feedback = new FeedbackViewModel
            {
                Message = "Registration is currently closed",
                Type = FeedbackType.Danger
            };
        }
    }

    private async Task HandleValidSubmitAsync()
    {
        ServiceResult result = await IdentityService.RegisterUserAsync(Model.Email);
        Feedback = FeedbackViewModel.FromServiceResult(result);
    }
}
