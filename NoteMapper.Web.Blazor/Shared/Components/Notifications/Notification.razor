@implements IDisposable
@using NoteMapper.Services.Feedback

<div class="toast fade show" role="alert" 
    data-nm-toast-id="@Id.ToString()" data-nm-toast-hideafter-seconds="@HideAfter?.TotalSeconds">
    @if (Header != null)
    {
        <div class="toast-header">
            <span class="me-auto">
                @Header
            </span>
            <button type="button" class="btn-close" @onclick="OnDismiss"></button>
        </div>
    }
    
    @if (HideAfter != null)
    {
        <ProgressBar Value="@Progress" Thin="true" />
    }    

    <div class="toast-body d-flex">
        <span class="me-auto">
            @Content
        </span>
        @if (Header == null)
        {
            <button type="button" class="btn-close" @onclick="OnDismiss"></button>
        }
    </div>
</div>

@code {
    [Parameter]
    public RenderFragment? Content { get; set; }

    [Parameter]
    public string? Header { get; set; }

    [Parameter]
    public TimeSpan? HideAfter { get; set; }

    [Parameter]
    public EventCallback OnDismiss { get; set; }

    Guid Id { get; } = Guid.NewGuid();

    double Progress { get; set; }

    DateTime Start { get; } = DateTime.Now;

    Timer? Timer { get; set; }

    public void Dispose()
    {
        if (Timer != null)
        {
            Timer.Dispose();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        if (HideAfter != null)
        {
            Timer = new Timer(OnTick);
            Timer.Change(0, 100);
        }
    }

    void OnTick(object? _)
    {
        if (HideAfter == null)
        {
            return;
        }

        if (DateTime.Now >= Start + HideAfter.Value)
        {
            InvokeAsync(OnDismiss.InvokeAsync);
            return;
        }

        Progress = ((double)(DateTime.Now - Start).Ticks / HideAfter.Value.Ticks);
        InvokeAsync(StateHasChanged);
    }
}
