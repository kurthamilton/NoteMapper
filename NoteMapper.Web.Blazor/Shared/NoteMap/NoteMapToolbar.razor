@using NoteMapper.Core.Guitars;
@using NoteMapper.Web.Blazor.Models.NoteMap;

@if (Instrument == null)
{
    return;
}

<div class="btn-toolbar">
    <div class="btn-group btn-group-sm me-3">
        <button class="btn btn-outline-secondary @(CanZoom(1) ? "" : "disabled")"
                @onclick="e => Zoom(1)">
            <span class="bi bi-zoom-out" aria-hidden="true"></span>
        </button>

        <button class="btn btn-outline-secondary @(CanZoom(-1) ? "" : "disabled")"
                @onclick="e => Zoom(-1)">
            <span class="bi bi-zoom-in" aria-hidden="true"></span>
        </button>
    </div>
    <div class="btn-group btn-group-sm">
        <button class="btn btn-outline-secondary @(CanMove(-1) ? "" : "disabled")"
                @onclick="e => Move(-1)">
            <span class="bi bi-caret-left" aria-hidden="true"></span>
        </button>

        <button class="btn btn-outline-secondary @(CanMove(1) ? "" : "disabled")"
                @onclick="e => Move(+1)">
            <span class="bi bi-caret-right" aria-hidden="true"></span>
        </button>
    </div>
</div>

@code{
    [Parameter]
    public GuitarBase? Instrument { get; set; }

    [Parameter]
    public EventCallback<NoteMapZoomViewModel> OnChange { get; set; }

    int EndFret { get; set; }
    int LastFret { get; set; }
    int StartFret { get; set; }
    int TotalFrets { get; set; }
    int VisibleFrets { get; set; }

    private GuitarBase? PreviousInstrument { get; set; }

    protected override void OnParametersSet()
    {
        if (Instrument == null || Instrument == PreviousInstrument)
        {
            return;
        }

        TotalFrets = Instrument.Frets + 1;
        VisibleFrets = TotalFrets;
        StartFret = 0;
        LastFret = Instrument.Frets;
        EndFret = LastFret;

        PreviousInstrument = Instrument;
        TriggerChange();
    }

    private bool CanMove(int offset)
    {
        if (offset == 0)
        {
            return false;
        }

        return offset < 0 
            ? StartFret + offset >= 0 
            : EndFret + offset <= LastFret;
    }

    private bool CanZoom(int offset)
    {
        if (offset == 0)
        {
            return false;
        }

        return offset < 0
            ? VisibleFrets + offset >= 1
            : VisibleFrets + offset <= TotalFrets;
    }

    private async Task Move(int offset)
    {
        if (!CanMove(offset))
        {
            return;
        }

        StartFret += offset;
        EndFret += offset;

        await TriggerChange();
    }

    private Task TriggerChange()
    {
        return OnChange.InvokeAsync(new NoteMapZoomViewModel
        {
            EndFret = EndFret,
            StartFret = StartFret
        });
    }

    private async Task Zoom(int offset)
    {
        if (!CanZoom(offset))
        {
            return;
        }

        VisibleFrets += offset;

        if (offset < 0)
        {
            EndFret += offset;
        }
        else
        {
            if (CanMove(offset))
            {
                EndFret += offset;
            }
            else
            {
                StartFret -= offset;
            }
        }

        await TriggerChange();
    }
}